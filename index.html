<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GBC Daily Devotional</title>
<style>
  :root {
    --arrow-size: 18px;
    --arrow-color: #2a2a2a;
    --arrow-rotation: 90deg;
    --box-bg: rgba(255, 255, 255, 0.95);
    --box-radius: 10px;
    --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    --font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    --padding-base: 10px;
    --margin-base: 10px;
    --transition-speed: 0.3s;
  }

  body, html {
    margin: 0; padding: 0;
    font-family: var(--font-family);
    background: transparent;
    color: #000;
  }

  #bg-image {
    position: fixed;
    inset: 0;
    background-position: center;
    background-size: cover;
    opacity: 0.8;
    z-index: -1;
    filter: brightness(0.9);
  }

  .container {
    max-width: 900px;
    margin: var(--margin-base) auto;
    padding: 0 var(--margin-base);
  }

  #date {
    font-size: 3em;
    font-weight: bold;
    color: white;
    margin: var(--margin-base) 0;
    user-select: none;
  }

  .box {
    background-color: var(--box-bg);
    border-radius: var(--box-radius);
    box-shadow: var(--box-shadow);
    padding: var(--padding-base);
    margin-bottom: var(--margin-base);
  }

  .collapsible-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    font-weight: bold;
    font-size: 1.1em;
    padding: var(--padding-base);
    background: none;
    border: none;
    width: 100%;
    box-sizing: border-box;
    transition: background var(--transition-speed);
  }

  .collapsible-header:focus {
    outline: 2px solid #ccc;
  }

  .arrow-icon {
    width: var(--arrow-size);
    height: var(--arrow-size);
    fill: var(--arrow-color);
    transition: transform var(--transition-speed);
  }

  .collapsible-header.active .arrow-icon {
    transform: rotate(var(--arrow-rotation));
  }

  .collapsible-content {
    display: none;
    padding: var(--padding-base);
    border-top: 1px solid #ddd;
    animation: fadeIn var(--transition-speed) ease-in-out;
  }

  .collapsible-content.show {
    display: block;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .podcast-player select {
    width: 100%;
    padding: var(--padding-base);
    font-size: 1em;
    border-radius: 4px;
    margin-bottom: var(--margin-base);
  }

  audio {
    width: 100%;
    margin-top: var(--margin-base);
    border-radius: 4px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  }

  ul.members-list, ol {
    list-style-position: inside;
    margin: 0;
    padding-left: 0;
  }

  ul.members-list li, ol li {
    margin-bottom: var(--margin-base);
  }

  #psalm-content {
    text-align: justify;
    line-height: 1.5;
    min-height: 60px;
  }
</style>
</head>
<body>
<div id="bg-image"></div>
<div class="container">
  <div id="date"></div>

  <div class="box">
    <button class="collapsible-header">
      Daily Scripture
      <svg class="arrow-icon" viewBox="0 0 24 24">
        <path d="M8 5v14l11-7z"/>
      </svg>
    </button>
    <div class="collapsible-content" id="psalm-content">Loading...</div>
  </div>

  <div class="box">
    <button class="collapsible-header">
      Podcast
      <svg class="arrow-icon" viewBox="0 0 24 24">
        <path d="M8 5v14l11-7z"/>
      </svg>
    </button>
    <div class="collapsible-content podcast-player" id="podcast-player">
      <select id="episode-select"></select>
      <audio id="audio-player" controls></audio>
    </div>
  </div>

  <div class="box">
    <button class="collapsible-header">
      Prayer List
      <svg class="arrow-icon" viewBox="0 0 24 24">
        <path d="M8 5v14l11-7z"/>
      </svg>
    </button>
    <div class="collapsible-content">
      <ul class="members-list" id="prayer-members"></ul>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const formatDate = () => {
      const dt = new Date();
      return `<div>${dt.toLocaleDateString(undefined, {weekday:'long'})}</div><div>${dt.getDate()} ${dt.toLocaleDateString(undefined, {month:'long'})} ${dt.getFullYear()}</div>`;
    };
    document.getElementById("date").innerHTML = formatDate();

    document.querySelectorAll(".collapsible-header").forEach(header => {
      header.addEventListener("click", () => {
        header.classList.toggle("active");
        const content = header.nextElementSibling;
        content.classList.toggle("show");
      });
    });

    const hash = [...new Date().toISOString().slice(0,10).replace(/-/g,'')].reduce((h,c)=>h*31+c.charCodeAt(0),0);
    const rand = h => Math.abs(Math.sin(h)) % 1;

    // Background image
    const bg = document.getElementById("bg-image");
    const storedDate = localStorage.getItem("bgDate");
    const storedUrl = localStorage.getItem("bgUrl");
    const seed = new Date().toISOString().slice(0,10);

    if (storedDate === seed && storedUrl) {
      bg.style.backgroundImage = `url('${storedUrl}')`;
    } else {
      fetch("https://api.unsplash.com/photos/random?query=landscape&orientation=landscape&client_id=aa3DZ6SZRXFXkV2Hk90D4F7XdTi6bSPbNekst2guXro")
        .then(res => res.json())
        .then(data => {
          const url = data.urls?.full || data.urls?.regular;
          if (url) {
            bg.style.backgroundImage = `url('${url}')`;
            localStorage.setItem("bgUrl", url);
            localStorage.setItem("bgDate", seed);
          }
        })
        .catch(() => {
          bg.style.backgroundImage = "url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1600&q=80')";
        });
    }

    // Prayer list shuffle
    const members = ["Chris Fall","Amy Fall","Aron Williams","Isabel Williams","Lee Jones","Sam Smith"];
    const shuffled = [...members];
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(rand(hash + i) * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    const prayerList = document.getElementById("prayer-members");
    prayerList.innerHTML = '';
    shuffled.slice(0, 2).forEach(m => {
      const li = document.createElement('li');
      li.textContent = m;
      prayerList.appendChild(li);
    });

    // Podcast
    fetch(`https://corsproxy.io/?${encodeURIComponent('https://anchor.fm/s/5073b270/podcast/rss')}`)
      .then(r => r.text())
      .then(xml => {
        const doc = new DOMParser().parseFromString(xml, "application/xml");
        const items = [...doc.querySelectorAll("item")];
        const select = document.getElementById("episode-select");
        const audio = document.getElementById("audio-player");
        items.forEach((item, i) => {
          const title = item.querySelector("title")?.textContent || `Episode ${i+1}`;
          const url = item.querySelector("enclosure")?.getAttribute("url");
          if (url) {
            const opt = document.createElement("option");
            opt.value = url;
            opt.textContent = title;
            select.appendChild(opt);
          }
        });
        select.selectedIndex = 0;
        audio.src = select.value;
        select.onchange = () => audio.src = select.value;
      })
      .catch(() => {
        document.getElementById("podcast-player").innerHTML = `<p style="color:red;">Podcast load failed.</p>`;
      });

    // Psalm
    fetch(`https://bible-api.com/psalm+${1 + Math.floor(rand(hash) * 150)}?translation=web`)
      .then(res => res.json())
      .then(data => {
        const psalm = document.getElementById("psalm-content");
        if (data.reference && data.verses) {
          psalm.innerHTML = `<strong>${data.reference}</strong><br>` + data.verses.map(v => `<sup>${v.verse}</sup> ${v.text.trim()}`).join(' ');
        } else {
          psalm.textContent = "Failed to load Psalm.";
        }
      })
      .catch(() => {
        document.getElementById("psalm-content").textContent = "Failed to load Psalm.";
      });
  });
</script>
</body>
</html>
